# 2019-09-15

|Time|Icon|Name|Message|
|---|---|---|---|
|02:39|![](https://secure.gravatar.com/avatar/1ac180f0868137292905c311b5fff781.jpg?s=72&d=https%3A%2F%2Fa.slack-edge.com%2Fdf10d%2Fimg%2Favatars%2Fava_0021-72.png)|spring-raining|ありがとうございます、ではこのまま作業を進めますー|
|07:29|![](https://avatars.slack-edge.com/2019-06-22/674537731207_65d60a0f5a770df7a1a0_72.png)|小形克宏|私の分を校正しました。ご確認ください。もし分かりづらいところ等あれば、なんなりとご質問・ご指摘ください。<br>https://vivliostyle.slack.com/files/UJS3RCS86/FN67Z43LZ/20190915_ogata.pdf|
|10:01|![](https://avatars.slack-edge.com/2018-04-27/354445776386_e258f5ed5ba887b08668_72.jpg)|shinyu|私の著者名のところ、このようにしてみました:<br><https://github.com/spring-raining/tbf07-draft/pull/5/files>|
|10:25|![](https://avatars.slack-edge.com/2018-04-27/354445776386_e258f5ed5ba887b08668_72.jpg)|shinyu|`@田嶋　淳` さんの原稿の次のところ、修正提案です:<br><br><blockquote>EPUB の表示に対応したと村上さんからお聞きしたとき、</blockquote>“対応した” → “対応済み”<br><br>**理由:** EPUB表示は実は初期からできました（解凍EPUBのディレクトリを指定。ベースがEPUBの拡張であるEPUB Adaptive Layout実装なので）。新しいのは、EPUB OPFファイルを指定しても表示できるようになったということです。<br><br><blockquote>Vivliostyle は本来サーバサイドで動かすようなソフトウェアなので、</blockquote>“サーバサイドで” → “サーバに置いて”<br><br>**理由:** 「サーバサイドで動かす」というのは違うのです。VivliostyleはWebサーバー上に置きますが、サーバー上でVivliostyleのプログラムが動くわけではなくて、ブラウザの中でJavaScriptが動くのです。つまりVivliostyleをサーバに置いても、サーバサイドで動くのではなくて、サーバからダウンロードされて、クライアントサイドで動くのです。コンテンツデータはサーバーにアップロードされて処理されるわけではありません。ブラウザの中だけで処理されます。「サーバに置いて」という表現に直せば大丈夫になると思います。|
|10:27|![](https://secure.gravatar.com/avatar/698cc14290c3976fdd9f0a23494b87c1.jpg?s=72&d=https%3A%2F%2Fa.slack-edge.com%2Fdf10d%2Fimg%2Favatars%2Fava_0012-72.png)|田嶋　淳|了解です。どういう形で直せば良いでしょうか？Github内で直すとしてどういう操作が要りますか？|
|10:27|![](https://avatars.slack-edge.com/2018-04-27/354445776386_e258f5ed5ba887b08668_72.jpg)|shinyu|`@spring-raining` さんが直してくれるでしょう|
|10:30|![](https://secure.gravatar.com/avatar/698cc14290c3976fdd9f0a23494b87c1.jpg?s=72&d=https%3A%2F%2Fa.slack-edge.com%2Fdf10d%2Fimg%2Favatars%2Fava_0012-72.png)|田嶋　淳|はーい。お任せしてよいならお願いいたします。|
|11:03|![](https://avatars.slack-edge.com/2018-04-27/354445776386_e258f5ed5ba887b08668_72.jpg)|shinyu|`@小形克宏` さんの原稿の次のところ修正提案です:<br><br><pre>p {<br>     margin-left: 6em; /* ブロック全体を 6em 左（縦の場合は上）に */<br>     text-indent: -6em; /* 先頭行のみ 6em 右（縦の場合は下）に */<br>}</pre><br><br>このコメントを次のように修正<br><br><pre>/* ブロック全体を 6em 左（縦の場合は上）インデント */<br>/* 先頭行のみ 6em 左（縦の場合は上）に突き出し */</pre>|
|11:35|![](https://avatars.slack-edge.com/2019-06-22/674537731207_65d60a0f5a770df7a1a0_72.png)|小形克宏|あー、たしかに。<br>村上さんの修正提案を受け入れます。|
|13:52|![](https://avatars.slack-edge.com/2019-06-22/674537731207_65d60a0f5a770df7a1a0_72.png)|小形克宏|`@spring-raining` さん、もう修正してしまったでしょうか。<br><br>校正を読み直していたら、23ページ冒頭のHTMLソースが間違っていることに気づきました。この段階ではまだ書いていないはずの縦中横のclassが指定されてしまっています。<br><br>今までの校正に、村上さんの修正提案もふくめて、修正を追記したPDFを添付します。<br>お手間をとらせますが、こちらのPDFで修正をお願いできないでしょうか。<br>https://vivliostyle.slack.com/files/UJS3RCS86/FN19QG3U3/20190915_ogata_b.pdf|
|13:59|![](https://secure.gravatar.com/avatar/1ac180f0868137292905c311b5fff781.jpg?s=72&d=https%3A%2F%2Fa.slack-edge.com%2Fdf10d%2Fimg%2Favatars%2Fava_0021-72.png)|spring-raining|はい、まだ大丈夫です！修正しておきます|
|14:17|![](https://secure.gravatar.com/avatar/1ac180f0868137292905c311b5fff781.jpg?s=72&d=https%3A%2F%2Fa.slack-edge.com%2Fdf10d%2Fimg%2Favatars%2Fava_0021-72.png)|spring-raining|上記のPDFの修正コメントが元のソースコードと変わっていないようですが、 `&lt;span class="text-combine"&gt;` タグを外すということで良かったですか？|
|14:21|![](https://avatars.slack-edge.com/2019-06-22/674537731207_65d60a0f5a770df7a1a0_72.png)|小形克宏|あれ、本当だ、変更しそびれてしまったようです。<br><br><blockquote> ｀&lt;span class="text-combine"&gt;｀ タグを外すということで良かったですか？</blockquote>はい、その通りです。すみませんが修正しておいてください。|
|19:08|![](https://avatars.slack-edge.com/2018-04-27/354445776386_e258f5ed5ba887b08668_72.jpg)|shinyu|`@spring-raining` `@小形克宏` CSSのコメントの「ブロック全体を 6em 左…」の修正するところ、２箇所（index.md の63行目と167行目）にあるうち最初の方がまだ直ってません。<br><https://github.com/spring-raining/tbf07-draft/blob/master/content/ogata/index.md><br>それから、この修正をすると、組版結果では行が長くなって、コメントの途中で切れてしまいます。それに、この CSS は論理プロパティではない `margin-left` のコメントに「縦の場合は上」とあるのは誤解されます。そこで２箇所とも次のように直すこと再提案です:<br><pre>p {<br>     margin-left: 6em; /* ブロック全体を 6em インデント */<br>     text-indent: -6em; /* 先頭行のみ 6em 突き出し */<br>}</pre><br><blockquote><pre>---<br>title: Vivliostyleで縦組シナリオを組版する<br>author:<br>  - 小形克宏<br>---<br><br># Vivliostyleで縦組シナリオを組版する<br><br>&lt;div class="draft-author"&gt;<br>小形克宏（電脳マヴォ合同会社）&lt;span class="footnote" style="text-align: left;"&gt;&lt;a href="https://www.mavo.co.jp/"&gt;<https://www.mavo.co.jp/&lt;/a&gt;&lt;/span>&gt;<br>&lt;/div&gt;<br><br>## はじめに<br><br>私は小さなエージェント会社に勤務している。仕事はマンガの編集・制作だ。ちょっと前に、あるオリジナル・シナリオをマンガ化するクラウドファンディングをおこなった[^2]。<br><br>[^2]:「森達也原作マンガ『死刑（仮）』第1話45ページを完成させたい」<https://camp-fire.jp/projects/view/153218><br><br>幸い目標額を達成できたので、今度はそのシナリオを読みやすく組み、リターン品として支援者にお届けすることになった。そこで、この機会に以前から興味のあった Vivliostyle に挑戦することを思い立った。まず、出発点である Word のオリジナル原稿を示しておこう（[@fig:fig_1]）。<br><br>![オリジナルのWordによる原稿](fig_1.png)<br><br>それでも、仕事で InDesign は使ってきたものの、HTML やら CSS は耳学問のみ。具体的に言うと「class 定義、@page ルールってなんでしたっけ」というレベル。実際、私がまず最初にしたことは、図書館に行って、HTML や CSS の入門書を読むことだった。まあ、そこから始まる過程全てを再現しても、読者には退屈なだけだろう。そこで、本稿では組版的に興味深いトピックに絞って追うことにする。<br><br>## シナリオ組版ってなんだ!?<br><br>私自身、映画や演劇を見るのは好きだが、作る側での関わりはない。だからシナリオについてもほとんど知識がない。まずは組む対象を知らなければ。そこでネット上をあれこれ画像検索したところ、以下のような組み方の特徴があることがわかった。<br><br>1. 役名から一定の間隔を空け、同じ位置でセリフが始まる→セリフ部分の行頭が揃う<br>2. 役名の文字数は作品により幅がある→あらかじめ文字数を勘案してセリフの開始位置を決めないとうまく揃わない<br>3. ト書きはフォント、インデントや囲みなどにより、役名+セリフから強く区別される<br><br>衆目の一致するところ、組版的に最も面倒臭いのは 1 と 2 だろう。図にすると以下のようになる（[@fig:fig_2]）。<br><br>![シナリオ組版の特徴](fig_2.png)<br><br>じっと見るうちにハタと気づいた。ア、ナルホドネ、要するにこれは「突き出しインデント+タブ区切り」なのだ。<br><br>突き出しインデントとはなにか。たぶん最も身近で見かける例は、この原稿でも数行前で使っている箇条書きだ。ご覧いただくと分かるとおり、折り返した 2 行目の行頭がインデントされ、1 行目の文章部分の最初と揃っている。結果として文頭の数字部分が文章部分から突き出ることになる。シナリオの場合は、この突き出た数字部分が何文字かに増え、役名になるわけである。<br><br>しかしこれだけでは実現できない。「一定の位置に揃える」ために役名とセリフをタブで区切ることが重要だ。タブとは任意の位置に文字を揃える機能のこと。文字数が 0 の場合において、タブの入力位置（つまり行頭）からその次の文字までの距離を「タブ幅」という。たとえばタブ幅が 6em とすれば、タブより前に 6em 未満=1〜5em の文字があった場合でも、タブの次の文字は同じ位置に揃ってくれる（[@fig:fig_3]）。シナリオの場合、役名が 1〜5 文字に収まれば、セリフ部分の開始位置がきれいに揃うわけだ。<br><br>![タブ幅6emの場合のふるまい。タブの前の文字数が6eｍ未満の場合は、タブの次の文字の開始位置がきれいに揃う](fig_3.png)<br><br>## InDesignで仮組みしてみる<br><br>こうしてシナリオ組版のアルゴリズムは分かった。しかしここでいきなり不馴れな HTML + CSS に挑戦するのは、私には敷居が高すぎる。そこで、まず手慣れた InDesign でテスト組版をすることにした。いろいろ試した結果、あらかじめ役名とセリフをタブで区切っておいたテキストに対し、次のような段落スタイルを適用することで実現できることが分かった（[@fig:fig_4]）。<br><br>![シナリオ組版を実現するInDesignの段落スタイル設定](fig_4.png)<br><br>ここでポイントとなるのは、左／上インデントと 1 行目インデントの数値だ。設定パネルを見ると、同じ数の正の値が前者に、負の値が後者に与えられていることが分かるだろう。これにより、①段落全体を特定の数値でインデント（左/上インデント）させた上で、②1 行目だけが段落全体のインデントと同じ量だけ突き出すことになる。以下はこの設定の適用結果だ（[@fig:fig_5]）。<br><br>![前図の設定を適用した結果](fig_5.png)<br><br>## CSSで実現するための試行錯誤<br><br>ここまでをまとめると、前項で解明した「役名とセリフをタブで区切る」「段落全体をインデントさせ、1 行目のみインデントと同じ量だけ突き出す」の 2 つを、HTML + CSS で実現すればよいということだ。やったね、これで楽勝じゃん。<br><br>もちろん、世の中それほど甘くない。とはいえ突き出しインデントに限れば、ありふれた表現だけに CSS でも簡単に実現できる。<br></pre>css<br>p {<br>     margin-left: 6em; /* ブロック全体を 6em 左（縦の場合は上）に */<br>     text-indent: -6em; /* 1行目だけ 6em 右（縦の場合は下）に */<br>}<br><pre><br>つまりブロック全体の左／上の余白サイズを `margin` プロパティで、ブロック 1 行目のインデントを `text-indent` プロパティで指定する。<br><br>問題はタブ区切りだ。役名とセリフをタブ区切りしたテキストを HTML にしてブラウザで表示させると以下のようになってしまう（[@fig:fig_6]）。なお、この段階では縦組は後回しにしている。<br><br>![タブを使用したHTMLの表示結果](fig_6.png)<br><br>役名とセリフの区切りが、スペース（U+0020）1 つに置き換わってしまった。これでは狭苦しくていけないし、そもそもセリフの開始位置が揃っておらず、セリフ 2 行目もインデントされていない。では、HTML でタブを表現するにはどうすればよいのか。<br><br>調べると `white-space` というプロパティがあることが分かった。これを使えばソース中のタブ等をそのまま表示してくれるらしい。そこで HTML の `p` 要素に対し、以下のように指定した。<br></pre>html<br>&lt;p style="white-space: pre;"&gt;<br>  &lt;strong&gt;存置B&lt;/strong&gt;それはメディアの問題です。<br>&lt;/p&gt;<br>&lt;p style="white-space: pre;"&gt;<br>  &lt;strong&gt;存置A&lt;/strong&gt;争点をずらしているよ。<br>&lt;/p&gt;<br>&lt;p style="white-space: pre;"&gt;<br>  &lt;strong&gt;片桐&lt;/strong&gt;遺族の気持ちを死刑の理由にするならば、もしも天涯孤独の人が殺されたとき、遺族はいないからその罪は軽くなります。それでいいのですか。<br>&lt;/p&gt;<br><pre><br>これをブラウザで表示させたのが以下のものだ（[@fig:fig_7]）。<br><br>![white-spaceプロパティを使ったHTMLの表示結果。行が折り返されなくなってしまった](fig_7.png)<br><br>3 行目を見ていただくと分かるとおり、行が折り返されていない。`white-space`プロパティはコードを表示するためのものなので、これは当然の振る舞いと言える。また、タブの方も 1 行目と 2 行目は役名の文字の長さがタブ幅を超えてしまったらしく、セリフの開始位置が 3 行目と揃っていない。<br><br>その後、`white-space: pre` のかわりに `white-space: pre-wrap`の指定をすると、タブ等の空白文字をそのまま表示し、行の折り返しもしてくれることを知った。とはいえ、タブ幅を指定できるわけではないので、[@fig:fig_7]と同様の問題は残る。やっぱりダメだこりゃ。<br><br>ここでハタと気づいた。そもそもなぜ HTML では強制的にタブがスペースに置き換えられたのか。考えてみれば、同じようにタブを入力した場合でも、OS、アプリケーションなど環境によってタブ幅は変わる（設定により変えられる）。HTML + CSS では多様なデバイスで同じ表示結果が求められることを考えれば、むしろタブを機能させないのは合理的な判断なのだ。つまり、私のアプローチがあさっての方向に暴走していたわけだ。となると新たにタブを使わない CSS での表現方法を見つけないといけない……。<br><br>## 村上さんのアドバイス降臨！<br><br>困ったな、なんとかならないっすかね、と slack で泣きついたら、Vivliostyle の開発者・村上真雄さんから、速攻で以下のようなアドバイスをいただいた（以下、村上 CSS と略）。<br><br><blockquote>- style= “white-space: pre;” は削除<br>- 役名（ `&lt;strong&gt;` タグ）ではじまるセリフの段落を他の段落と区別できるように `class` をつける<br>- CSSでセリフの段落に対し、以下のように指定</blockquote>css<br>p.line {<br>     margin-inline-start: 6em;<br>     margin-block-start: 0;<br>     margin-block-end: 0;<br>}<br>p.line &gt; strong:first-child {<br>     margin-inline-start: -6em;<br>     min-inline-size: 6em;<br>     display: inline-block;<br>}</pre><br><br>見ると分かるとおり、上記では突き出しインデント+タブ区切りを実現するだけでなく、最新のプロパティを使うことで、同一の指定で縦組にも横組にも使えるよう工夫されている。すばらしい！　いやあ、コミュニティって神。みんなも Vivliostyle の slack に参加するといいよ！[^3]<br><br>[^3]: Vivliostyle 公式サイトの「コミュニティ」ページ <https://vivliostyle.org/ja/community/> から参加可能。<br><br>以下、この村上 CSS の詳細について、その後調べたことを元に解説していこう。<br><br>### 論理プロパティについて<br><br>まず、村上 CSS で使われている以下のプロパティは、新しい概念にもとづく「論理プロパティ」と呼ばれるものだ。<br><br>- margin-block-start<br>- margin-block-end<br>- margin-inline-start<br>- min-inline-size<br><br>ここでいう「論理」（logical）とは、従来のような物理的（physical）ではなく論理的な方向・サイズを扱うことに由来する。<br><br>たとえば、これまで使われてきた物理プロパティ `margin-top` 、`margin-right`、`margin-bottom`、`margin-left` に対応する論理プロパティは `margin-block-start`、`margin-inline-end`、`margin-block-end`、`margin-inline-start`だ。この例から分かるように、今までは top、right、bottom、left という物理的（絶対的）な方向を使って指定してきたが、論理プロパティでは start や end という論理的（相対的）な方向を使っている。<br><br>これを使う最⼤のメリットは特定の組み⽅向に依存しないで記述できることだ。今までは横組を前提に書かれた CSS を縦組に切り換えようとすれば、⽅向やサイズに関連するプロパティの値を⼀つ⼀つ書き換えなければならなかった。しかし論理プロパティを使えば、`writing-mode`プロパティで組み⽅向の指定を変更するだけですむ（[@fig:fig_8]）[^4]。<br><br>[^4]:より詳細は以下の記事を参照。「[CSS\]知っておくと便利な論理プロパティ、ボックスモデルにおける古い方法とこれからの方法」<https://coliss.com/articles/build-websites/operation/css/new-css-logical-properties.html><br><br>![物理プロパティで横組から縦組に切り換えようとする場合、横組のプロパティの値を、図中の同じ丸付き数字の縦組プロパティに書き写さなければならない。対して論理プロパティでは丸付き数字とプロパティが縦組／横組で変わらないことから分かるように、こうした複雑な修整は不要だ](fig_8.png)<br><br>論理プロパティを規定する仕様が “CSS Logical Properties and Values Level 1”[^5] だ。`writing-mode`プロパティを規定する “CSS Writing Modes Level 3” [^6]を実装するには論理プロパティが必要になることもあり、まだワーキングドラフトの段階であるにも関わらず、プラウザへの実装は順調に進んでいる[^7]。<br><br>[^5]: <https://drafts.csswg.org/css-logical/><br><br>[^6]: <https://www.w3.org/TR/css-writing-modes-3/><br><br>[^7]: <https://wpt.fyi/results/css/css-logical?label=experimental&amp;label=master&amp;aligned><br><br><br><br>### 突き出しインデントについて<br><br>その論理プロパティを使って、どうやって突き出しインデントを実現するのか。あらためて InDesign における突き出しインデントの実現方法を振り返ると、以下の通りだった。<br><br>1. 段落全体を特定の数値でインデント（左／上インデント）させる<br>2. 1 ⾏⽬のみ段落全体のインデントと同じ量だけ突き出す<br><br>そして物理プロパティでは、`margin`でプロック全体を正の値で、`text-indent`で 1 行目だけ同じ数の負の値を指定するのだった。<br><br><pre>css<br>p {<br>     margin-left: 6em; /* ブロック全体を 6em 左（縦の場合は上）インデント */<br>     text-indent: -6em; /* 先頭行のみ 6em 左（縦の場合は上）に突き出し */<br>}</pre><br><br>では、論理プロパティではどう実現するか。まずト書き等と区別するため、あらかじめ HTML で指定したい箇所を `class` で定義しておく（ここでは `class` 名を “line” とした。もちろんこれは物理プロパティでも必要）。<br><br><pre>html<br>&lt;p class="line"&gt;<br>  &lt;strong&gt;存置&lt;span class="text-combine"&gt;B&lt;/span&gt;&lt;/strong&gt;<br>  それはメディアの問題です。<br>&lt;/p&gt;<br>&lt;p class="line"&gt;<br>  &lt;strong&gt;存置&lt;span class="text-combine"&gt;A&lt;/span&gt;&lt;/strong&gt;<br>  争点をずらしているよ。<br>&lt;/p&gt;<br>&lt;p class="line"&gt;<br>  &lt;strong&gt;片桐&lt;/strong&gt;<br>  遺族の気持ちを死刑の理由にするならば、もしも天涯孤独の人が殺されたとき、遺族はいないからその罪は軽くなります。それでいいのですか。<br>&lt;/p&gt;</pre><br><br>そのうえで、CSS で “line” ブロック全体の左／上余白を 6em に指定する。<br><br><pre>css<br>p.line {<br>     margin-inline-start: 6em;<br>     margin-block-start: 0;<br>     margin-block-end: 0;<br>}</pre><br><br>ここまでをブラウザで表示させたのが以下のもの（[@fig:fig_9]）。しかし、これではまだ半分、突き出しになっていない。<br><br>![ブロック全体を、左／上方向の余白として6emを指定する](fig_9.png)<br><br>そこで上記に加えて、“line” ブロックの 1 行目だけに負の値、-6em を指定したいわけだが、この特定のブロックの 1 行目「だけ」を特定するのに技が必要だ。<br><br>あらためて HTML をじっと見ると、役名が必ず子要素 `strong`で強調されている。これをキーにすれば特定できそうだ。子要素だけを指定するには親要素と子要素を `&gt;` でつなげばよい。<br><br>いや待ってほしい、`strong`は強調としてもよく使われるから、役名だけに使っていると決め打ちすると痛い目に遭う。もう一段、正確性を増すための絞り込みが必要だ。そこで疑似要素 `first-child` を使うことで、「`strong`要素が最初の要素である場合」と限定する。そのうえで、そこに負の値、-6em を指定する。以下のように。<br><br><pre>css<br>p.line &gt; strong:first-child {<br>     margin-inline-start: -6em;<br>}</pre><br><br>これをブラウザで表示させたのが以下のもの（[@fig:fig_10]）。ぶじに突き出しインデントになった。<br><br>![1行目だけ6em分突き出すように指定した](fig_10.png)<br><br>### セリフ部分の開始位置を揃える<br><br>あとはセリフ部分の開始位置を揃えればよい。再び HTML を観察すると、指定しようとする “line” は例外なく 2 つの要素で成り立っていることが分かる。つまり、行頭は `strong` 要素で指定された役名で始まり、それにセリフが続いている。ということは、行頭の要素（役名部分）のために…</blockquote>|
|19:36|![](https://avatars.slack-edge.com/2019-06-22/674537731207_65d60a0f5a770df7a1a0_72.png)|小形克宏|`@shinyu` `@spring-raining`<br>なるほど、了解しました。村上さんの再提案の通りにしましょう。|
