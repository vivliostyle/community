# 2023-09-05

|Time (UTC)|Icon|Name|Message|
|---|---|---|---|
|06:43|![](https://avatars.slack-edge.com/2018-04-27/354445776386_e258f5ed5ba887b08668_72.jpg)|shinyu|Cloud Run 上で build pdf が重複して繰り返し実行されるのを直したい<br><https://github.com/vivliostyle/vivliostyle-pub/issues/279><br><blockquote>Pub で Export→PDF を実行して正常にPDFが生成されているとき、Cloud Run のログを見ると、最初にPDFが生成されたあとも同じPDF生成が繰り返し実行されている。数えてみると12回ほど繰り返されている。（繰り返し数は一定ではなく数十回の場合もある）。<br><br><https://user-images.githubusercontent.com/3324737/265597668-a6531d49-3e3b-4393-b787-19ba2d5b7025.png|スクリーンショット 2023-09-05 14 18 59><br><br>Cloud Functions の buildPDF のログを見ると、Message の published は1回しか発生していない。それなのに Cloud Run 上では重複して繰り返し実行されている。<br><br><https://user-images.githubusercontent.com/3324737/265598123-8efe21b2-8fd0-4fc2-a273-0296ea96b414.png|スクリーンショット 2023-09-04 22 37 41><br><br>なぜ繰り返されるのか、どうしたら直せるのか？　Google Cloud のドキュメントの「<https://cloud.google.com/pubsub/docs/exactly-once-delivery?hl=ja|配信オプションの構成→1回限りの配信>」が役に立つかも。<br><br>> • 再配信は、メッセージに対してクライアントによる否定確認応答が行われた場合、または確認応答期限が切れる前にクライアントが確認応答期限を延長しなかった場合のいずれかか原因で発生することがあります。…<br>> • 重複とは、確認応答が成功した後、または確認応答期限が切れる前にメッセージが再送信された場合を指します。<br>> <br>> Pub/Sub では、1 回限りの配信が有効になっているサブスクリプションに対して、配信が重複しないことが保証されています。</blockquote>|
|10:58|![](https://avatars.slack-edge.com/2018-04-27/354445776386_e258f5ed5ba887b08668_72.jpg)|shinyu|サブスクリプションの設定の確認応答期限が10秒になってたのを最大値である600秒に変えたところ直ったよう。Cloud Runでの buildPDF が10〜数十回も重複して繰り返し実行されていて、ログの確認もしにくいし、余計に課金もかかるのではと悩んでいたのが解消。|
