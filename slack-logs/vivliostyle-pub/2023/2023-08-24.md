# 2023-08-24

|Time (UTC)|Icon|Name|Message|
|---|---|---|---|
|08:36|![](https://avatars.slack-edge.com/2018-04-27/354445776386_e258f5ed5ba887b08668_72.jpg)|shinyu|vivliostyle-pub の functions の firebase、google-cloud、octokitなどの依存ライブラリを最新に更新して、それに伴って必要なコードの修正をしようとして、webhookHandler について分からないところがあって悩んでます。<br>Draft PR:<br><https://github.com/vivliostyle/vivliostyle-pub/pull/277#issuecomment-1691169629><br><br>```export const webhookHandler = functions.https.onRequest(webhooks.middleware);```<br>となっていたのを `@octokit/webhooks` を最新にしたのに伴って必要な変更（`webhooks.middleware` を `createNodeMiddleware(webhooks)` に変更？）をしようとしてるのですが、うまくいかないです。どうするとよいでしょう？<br><br>すみません、分かるかた教えてくれませんか？　`@spring-raining` ?<br><blockquote>この更新を行った状態で deploy してみた。（/functions ディレクトリで `yarn deploy`）<br><br>Vivliostyle Pubでの編集作業や、PDF生成は正常にできているようである。<br><br>しかし、Google CloudのCloud Functionsのログを見てみると、webhookHandlerで<br><br>> Function execution took 60000 ms, finished with status: 'error'<br><br>のようにエラーが起きている。どうもすべての Function execution がこのようなerrorで終了しているようだ。<br><br><https://user-images.githubusercontent.com/3324737/262884457-2f540b5b-1e98-4dea-b28b-45acc7d2e761.png|スクリーンショット 2023-08-24 15 42 40><br><br>* * *<br><br>functions/src/webhookHandler/index.ts の<https://github.com/vivliostyle/vivliostyle-pub/pull/277/files#diff-844aefd09452c3d9b6ef287631f95a9a0763ee0fe2789a1c00f6f87e10933e24R42|変更>に問題があると思われる。次のところが怪しい：<br><br><https://github.com/octokit/webhooks.js|`@octokit/webhooks`>をv7からv12に更新したのに伴って、 `webhooks.middleware` を `createNodeMiddleware(webhooks)` に変更する必要があったので次のように変更した：<br><br><pre>export const webhookHandler = functions.https.onRequest(webhooks.middleware);</pre><br><br>↓<br><br><pre>export const webhookHandler = functions.https.onRequest(<br>  createNodeMiddleware(webhooks) as any,<br>);</pre><br><br>`as any` を付けた理由は、そのままでは次のエラーになるため：<br><br><pre>Argument of type '(request: any, response: any, next?: Function | undefined) => Promise<boolean>' <br>is not assignable to parameter of type '(req: Request, resp: Response<any>) => void | Promise<void>'.<br>  Type 'Promise<boolean>' is not assignable to type 'void | Promise<void>'.<br>    Type 'Promise<boolean>' is not assignable to type 'Promise<void>'.<br>      Type 'boolean' is not assignable to type 'void'.</pre><br><br>このように `createNodeMiddleware(webhooks)` の型（`(request: any, response: any, next?: Function | undefined) => Promise<boolean>`）が `functions.https.onRequest()` の引数の型（`(req: Request, resp: Response<any>) => void | Promise<void>`）と一致していなくて、うまくいかないのは当然のようである。<br><br>しかし、今回の `@octokit/webhooks` 更新とこの修正を行う前の<br><br><pre>export const webhookHandler = functions.https.onRequest(webhooks.middleware);</pre><br><br>でも型は合っていなかった。  <br>（`webhooks.middleware` の型は `(request: IncomingMessage, response: ServerResponse, next?: ((err?: any) => void) | undefined) => void | Promise<void>` で onRequest() の引数の型は `(req: Request, resp: Response<any>) => void`）<br><br>それでも動いていて、errorは発生しなかった。だから `@octokit/webhooks` の更新にともなうこの修正で `as any` を付けて型の不一致を無視しても動くかを試したのだった。<br><br>要調査・修正</blockquote>|
